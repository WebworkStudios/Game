<!-- app/Views/pages/test/template-cache.html -->
{% extends "layouts/base.html" %}

{% block title %}Template Cache Management - {{ app_name }}{% endblock %}

{% block content %}
<h2>üóÑÔ∏è Template Cache Management</h2>

<!-- Cache Statistics -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number">{{ cache_stats.total_files }}</div>
        <div class="stat-label">Cached Templates</div>
    </div>

    <div class="stat-card">
        <div class="stat-number">{{ cache_stats.total_size | number_format:0 }} bytes</div>
        <div class="stat-label">Cache Size</div>
    </div>

    <div class="stat-card">
        <div class="stat-number">{{ cache_stats.enabled | default:'No' }}</div>
        <div class="stat-label">Cache Enabled</div>
    </div>

    <div class="stat-card">
        <div class="stat-number">{{ engine_stats.filter_stats.loaded }}</div>
        <div class="stat-label">Loaded Filters</div>
    </div>
</div>

<!-- Cache Operations -->
<div class="operations-section">
    <h3>üîß Cache Operations</h3>
    <div class="button-group">
        <button onclick="clearCache()" class="btn btn-danger">
            üóëÔ∏è Clear All Cache
        </button>
        <button onclick="warmupCache()" class="btn btn-primary">
            üî• Warmup Cache
        </button>
        <button onclick="refreshStats()" class="btn btn-secondary">
            üîÑ Refresh Stats
        </button>
    </div>
    <div id="operation-result"></div>
</div>

<!-- Cache Details -->
<div class="details-section">
    <h3>üìä Cache Details</h3>

    <div class="detail-grid">
        <div class="detail-card">
            <h4>üìÅ Cache Directory</h4>
            <p><code>{{ cache_stats.cache_dir }}</code></p>
            <p><strong>Files:</strong> {{ cache_stats.total_files }}</p>
            <p><strong>Size:</strong> {{ cache_stats.total_size | number_format:0 }} bytes</p>
        </div>

        <div class="detail-card">
            <h4>‚ö° Filter Performance</h4>
            <p><strong>Available:</strong> {{ engine_stats.filter_stats.available }}</p>
            <p><strong>Loaded:</strong> {{ engine_stats.filter_stats.loaded }}</p>
            <p><strong>Lazy Remaining:</strong> {{ engine_stats.filter_stats.lazy_remaining }}</p>
        </div>

        <div class="detail-card">
            <h4>üïí Cache Timing</h4>
            {% if cache_stats.oldest_cache %}
            <p><strong>Oldest:</strong> {{ cache_stats.oldest_cache | date:'Y-m-d H:i:s' }}</p>
            {% endif %}
            {% if cache_stats.newest_cache %}
            <p><strong>Newest:</strong> {{ cache_stats.newest_cache | date:'Y-m-d H:i:s' }}</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Template Testing -->
<div class="testing-section">
    <h3>üß™ Template Testing</h3>
    <p>Test template rendering performance with and without cache:</p>

    <div class="test-grid">
        {% for templates_tested as template %}
        <div class="test-item">
            <strong>{{ template }}</strong>
            <button onclick="testTemplate('{{ template }}')" class="btn btn-small">Test Render</button>
            <div id="test-result-{{ template | slug }}"></div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Raw Data (Debug) -->
<details class="debug-section">
    <summary>üîç Debug Information</summary>

    <h4>Cache Stats:</h4>
    <pre>{{ cache_stats | json }}</pre>

    <h4>Engine Stats:</h4>
    <pre>{{ engine_stats | json }}</pre>
</details>

<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
    }

    .stat-number {
        font-size: 2em;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .stat-label {
        font-size: 0.9em;
        opacity: 0.9;
    }

    .operations-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }

    .button-group {
        display: flex;
        gap: 10px;
        margin: 15px 0;
        flex-wrap: wrap;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-primary:hover {
        background: #0056b3;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #545b62;
    }

    .btn-small {
        padding: 5px 10px;
        font-size: 0.8em;
        margin-left: 10px;
    }

    .details-section {
        margin: 30px 0;
    }

    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }

    .detail-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
    }

    .detail-card h4 {
        margin-bottom: 15px;
        color: #495057;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 5px;
    }

    .testing-section {
        background: #e8f5e8;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }

    .test-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin: 15px 0;
    }

    .test-item {
        background: white;
        padding: 15px;
        border-radius: 5px;
        border: 1px solid #c3e6cb;
    }

    .debug-section {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
    }

    .debug-section summary {
        cursor: pointer;
        font-weight: bold;
        margin-bottom: 15px;
    }

    #operation-result {
        margin: 15px 0;
        padding: 10px;
        border-radius: 5px;
        min-height: 20px;
    }

    .result-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .result-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    pre {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
        font-size: 0.9em;
        border: 1px solid #e9ecef;
    }

    code {
        background: #f8f9fa;
        padding: 2px 4px;
        border-radius: 3px;
        font-family: monospace;
    }
</style>
<!-- app/Views/pages/test/template-cache.html -->
<!-- Replace the script section with this fixed version: -->

<script>
    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', function() {
        // Now safely get CSRF token
        const csrfMeta = document.querySelector('meta[name="csrf-token"]');
        const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : '';

        // Make functions global so they can be called from onclick
        window.clearCache = async function() {
            try {
                showResult('Clearing cache...', 'info');

                const response = await fetch('/test/template-cache', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify({
                        action: 'clear',
                        _token: csrfToken
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showResult('‚úÖ ' + result.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showResult('‚ùå Failed to clear cache', 'error');
                }
            } catch (error) {
                showResult('‚ùå Error: ' + error.message, 'error');
            }
        };

        window.warmupCache = async function() {
            try {
                showResult('Warming up cache...', 'info');

                const response = await fetch('/test/template-cache', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify({
                        action: 'warmup',
                        _token: csrfToken
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showResult('üî• ' + result.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showResult('‚ùå Failed to warmup cache', 'error');
                }
            } catch (error) {
                showResult('‚ùå Error: ' + error.message, 'error');
            }
        };

        window.refreshStats = function() {
            showResult('üîÑ Refreshing...', 'info');
            setTimeout(() => location.reload(), 500);
        };

        window.testTemplate = async function(template) {
            const templateSlug = template.replace(/[^a-z0-9]/gi, '-').toLowerCase();
            const resultElement = document.getElementById('test-result-' + templateSlug);

            if (!resultElement) {
                console.error('Result element not found for template:', template);
                return;
            }

            try {
                resultElement.innerHTML = '‚è≥ Testing...';

                const startTime = performance.now();

                // Test by requesting the template (if it exists as route)
                const testUrl = '/' + template.replace('pages/', '').replace('/template-cache', '/template-cache-test');

                const response = await fetch(testUrl);
                const endTime = performance.now();

                if (response.ok) {
                    const renderTime = Math.round(endTime - startTime);
                    resultElement.innerHTML = `‚úÖ ${renderTime}ms`;
                    resultElement.style.color = '#28a745';
                } else {
                    resultElement.innerHTML = `‚ÑπÔ∏è No route`;
                    resultElement.style.color = '#6c757d';
                }
            } catch (error) {
                resultElement.innerHTML = `‚ùå Error`;
                resultElement.style.color = '#dc3545';
            }
        };

        function showResult(message, type) {
            const resultDiv = document.getElementById('operation-result');
            if (resultDiv) {
                resultDiv.innerHTML = message;
                resultDiv.className = 'result-' + type;
            }
        }

        // Make showResult available globally
        window.showResult = showResult;
    });
</script>
{% endblock %}
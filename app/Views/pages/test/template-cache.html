<!-- app/Views/pages/test/template-cache.html -->
{% extends "layouts/base.html" %}

{% block title %}Template Cache Management - {{ app_name }}{% endblock %}

{% block content %}
<h2>🗄️ Template Cache Management - Phase 3</h2>

<!-- Cache Statistics -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number">{{ cache_stats.total_files }}</div>
        <div class="stat-label">Total Cached Files</div>
    </div>

    <div class="stat-card">
        <div class="stat-number">{{ cache_stats.templates.files }}</div>
        <div class="stat-label">Template Files</div>
    </div>

    <div class="stat-card">
        <div class="stat-number">{{ cache_stats.fragments.files }}</div>
        <div class="stat-label">Fragment Files</div>
    </div>

    <div class="stat-card">
        <div class="stat-number">{{ cache_stats.tags.files }}</div>
        <div class="stat-label">Tag Files</div>
    </div>

    <div class="stat-card">
        <div class="stat-number">{{ cache_stats.total_size | number_format:0 }}</div>
        <div class="stat-label">Total Size (bytes)</div>
    </div>

    <div class="stat-card">
        <div class="stat-number">{{ engine_stats.filter_stats.loaded }}</div>
        <div class="stat-label">Loaded Filters</div>
    </div>
</div>

<!-- Cache Operations -->
<div class="operations-section">
    <h3>🔧 Cache Operations</h3>

    <!-- Basic Operations -->
    <div class="operation-group">
        <h4>Basic Operations</h4>
        <div class="button-group">
            <button class="btn btn-danger" onclick="clearCache()">
                🗑️ Clear All Cache
            </button>
            <button class="btn btn-primary" onclick="warmupCache()">
                🔥 Warmup Cache
            </button>
            <button class="btn btn-secondary" onclick="refreshStats()">
                🔄 Refresh Stats
            </button>
        </div>
    </div>

    <!-- Tag Operations -->
    <div class="operation-group">
        <h4>Tag-based Cache Management</h4>
        <div class="tag-operations">
            {% for test_tags as tag => description %}
            <div class="tag-item">
                <span class="tag-name">{{ tag }}</span>
                <span class="tag-description">{{ description }}</span>
                <button class="btn btn-small btn-warning" onclick="clearTag('{{ tag }}')">Clear</button>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Fragment Testing -->
    <div class="operation-group">
        <h4>Fragment & Tag Testing</h4>
        <div class="button-group">
            <button class="btn btn-info" onclick="testFragmentCaching()">
                🧪 Test Fragment Caching
            </button>
            <button class="btn btn-info" onclick="testTaggedCaching()">
                🏷️ Test Tagged Caching
            </button>
        </div>
    </div>

    <div id="operation-result"></div>
</div>

<!-- Cache Details -->
<div class="details-section">
    <h3>📊 Detailed Cache Information</h3>

    <div class="detail-grid">
        <div class="detail-card">
            <h4>📁 Templates Cache</h4>
            <p><strong>Files:</strong> {{ cache_stats.templates.files }}</p>
            <p><strong>Size:</strong> {{ cache_stats.templates.size | number_format:0 }} bytes</p>
            <p><strong>Directory:</strong> <code>{{ cache_stats.cache_dir }}/templates/</code></p>
        </div>

        <div class="detail-card">
            <h4>🧩 Fragments Cache</h4>
            <p><strong>Files:</strong> {{ cache_stats.fragments.files }}</p>
            <p><strong>Size:</strong> {{ cache_stats.fragments.size | number_format:0 }} bytes</p>
            <p><strong>Directory:</strong> <code>{{ cache_stats.cache_dir }}/fragments/</code></p>
            <p><strong>TTL Support:</strong> ✅ Enabled</p>
        </div>

        <div class="detail-card">
            <h4>🏷️ Tags Cache</h4>
            <p><strong>Files:</strong> {{ cache_stats.tags.files }}</p>
            <p><strong>Size:</strong> {{ cache_stats.tags.size | number_format:0 }} bytes</p>
            <p><strong>Directory:</strong> <code>{{ cache_stats.cache_dir }}/tags/</code></p>
            <p><strong>Smart Invalidation:</strong> ✅ Enabled</p>
        </div>

        <div class="detail-card">
            <h4>⚡ Filter Performance</h4>
            <p><strong>Available:</strong> {{ engine_stats.filter_stats.available }}</p>
            <p><strong>Loaded:</strong> {{ engine_stats.filter_stats.loaded }}</p>
            <p><strong>Lazy Remaining:</strong> {{ engine_stats.filter_stats.lazy_remaining }}</p>
            <p><strong>Load Ratio:</strong> {{ (engine_stats.filter_stats.loaded / engine_stats.filter_stats.available *
                100) | number_format:1 }}%</p>
        </div>

        <div class="detail-card">
            <h4>🕒 Cache Timing</h4>
            {% if cache_stats.oldest_cache %}
            <p><strong>Oldest:</strong> {{ cache_stats.oldest_cache | date:'Y-m-d H:i:s' }}</p>
            {% endif %}
            {% if cache_stats.newest_cache %}
            <p><strong>Newest:</strong> {{ cache_stats.newest_cache | date:'Y-m-d H:i:s' }}</p>
            {% endif %}
            <p><strong>Cache Enabled:</strong> {{ cache_stats.enabled | default:'No' }}</p>
        </div>

        <div class="detail-card">
            <h4>🎯 Phase 3 Features</h4>
            <p><strong>Fragment Caching:</strong> ✅ Implemented</p>
            <p><strong>TTL Support:</strong> ✅ Implemented</p>
            <p><strong>Tag System:</strong> ✅ Implemented</p>
            <p><strong>Smart Invalidation:</strong> ✅ Implemented</p>
            <p><strong>Multi-directory:</strong> ✅ Implemented</p>
        </div>
    </div>
</div>

<!-- Template Testing -->
<div class="testing-section">
    <h3>🧪 Template Rendering Tests</h3>
    <p>Test template rendering performance with the enhanced cache system:</p>

    <div class="test-grid">
        {% for templates_tested as template %}
        <div class="test-item">
            <strong>{{ template }}</strong>
            <button class="btn btn-small" onclick="testTemplate('{{ template }}')">Test Render</button>
            <div id="test-result-{{ template | slug }}"></div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Usage Examples -->
<div class="usage-section">
    <h3>💡 Usage Examples for Football Manager</h3>

    <div class="example-grid">
        <div class="example-card">
            <h4>Fragment Caching</h4>
            <pre><code>// Cache expensive player widget for 10 minutes
$engine->renderCached(
    'components/player-stats',
    ['player_id' => 123],
    600, // 10 minutes TTL
    ['player', 'player_123']
);</code></pre>
        </div>

        <div class="example-card">
            <h4>Live Match Data</h4>
            <pre><code>// Cache live scores for 30 seconds
$engine->renderCached(
    'components/live-scores',
    $matchData,
    30, // 30 seconds TTL
    ['live', 'match', 'current']
);</code></pre>
        </div>

        <div class="example-card">
            <h4>Smart Invalidation</h4>
            <pre><code>// Invalidate all player-related caches
$cache->invalidateByTag('player');

// Invalidate specific player
$cache->invalidateByTag('player_123');</code></pre>
        </div>

        <div class="example-card">
            <h4>Multi-Tag Invalidation</h4>
            <pre><code>// Clear multiple related caches
$cache->invalidateByTags([
    'team_456',
    'league_table',
    'standings'
]);</code></pre>
        </div>
    </div>
</div>

<!-- Raw Data (Debug) -->
<details class="debug-section">
    <summary>🔍 Debug Information</summary>

    <h4>Cache Stats:</h4>
    <pre>{{ cache_stats | json }}</pre>

    <h4>Engine Stats:</h4>
    <pre>{{ engine_stats | json }}</pre>

    <h4>Available Test Tags:</h4>
    <pre>{{ test_tags | json }}</pre>
</details>

<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
    }

    .stat-number {
        font-size: 2em;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .stat-label {
        font-size: 0.9em;
        opacity: 0.9;
    }

    .operations-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }

    .operation-group {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        background: white;
    }

    .operation-group h4 {
        margin-bottom: 15px;
        color: #495057;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 5px;
    }

    .button-group {
        display: flex;
        gap: 10px;
        margin: 15px 0;
        flex-wrap: wrap;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-primary:hover {
        background: #0056b3;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #545b62;
    }

    .btn-warning {
        background: #ffc107;
        color: #212529;
    }

    .btn-warning:hover {
        background: #e0a800;
    }

    .btn-info {
        background: #17a2b8;
        color: white;
    }

    .btn-info:hover {
        background: #138496;
    }

    .btn-small {
        padding: 5px 10px;
        font-size: 0.8em;
        margin-left: 10px;
    }

    .tag-operations {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 10px;
        margin: 15px 0;
    }

    .tag-item {
        display: flex;
        align-items: center;
        padding: 10px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
    }

    .tag-name {
        font-family: monospace;
        background: #e9ecef;
        padding: 2px 6px;
        border-radius: 3px;
        margin-right: 10px;
        min-width: 80px;
        text-align: center;
    }

    .tag-description {
        flex: 1;
        margin-right: 10px;
        color: #6c757d;
    }

    .details-section {
        margin: 30px 0;
    }

    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }

    .detail-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
    }

    .detail-card h4 {
        margin-bottom: 15px;
        color: #495057;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 5px;
    }

    .testing-section {
        background: #e8f5e8;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }

    .test-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin: 15px 0;
    }

    .test-item {
        background: white;
        padding: 15px;
        border-radius: 5px;
        border: 1px solid #c3e6cb;
    }

    .usage-section {
        background: #fff3cd;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }

    .example-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }

    .example-card {
        background: white;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 20px;
    }

    .example-card h4 {
        margin-bottom: 15px;
        color: #856404;
    }

    .example-card pre {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
        font-size: 0.9em;
        border: 1px solid #e9ecef;
    }

    .debug-section {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
    }

    .debug-section summary {
        cursor: pointer;
        font-weight: bold;
        margin-bottom: 15px;
    }

    #operation-result {
        margin: 15px 0;
        padding: 10px;
        border-radius: 5px;
        min-height: 20px;
    }

    .result-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .result-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .result-info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }

    pre {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
        font-size: 0.9em;
        border: 1px solid #e9ecef;
    }

    code {
        background: #f8f9fa;
        padding: 2px 4px;
        border-radius: 3px;
        font-family: monospace;
    }
</style>

<script>
    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', function () {
        // Get CSRF token
        const csrfMeta = document.querySelector('meta[name="csrf-token"]');
        const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : '';

        // Global functions for cache operations
        window.clearCache = async function () {
            try {
                showResult('Clearing all cache...', 'info');

                const response = await fetch('/test/template-cache', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify({
                        action: 'clear',
                        _token: csrfToken
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showResult('✅ ' + result.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showResult('❌ Failed to clear cache', 'error');
                }
            } catch (error) {
                showResult('❌ Error: ' + error.message, 'error');
            }
        };

        window.warmupCache = async function () {
            try {
                showResult('Warming up cache...', 'info');

                const response = await fetch('/test/template-cache', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify({
                        action: 'warmup',
                        _token: csrfToken
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showResult('🔥 ' + result.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showResult('❌ Failed to warmup cache', 'error');
                }
            } catch (error) {
                showResult('❌ Error: ' + error.message, 'error');
            }
        };

        window.clearTag = async function (tag) {
            try {
                showResult(`Clearing tag '${tag}'...`, 'info');

                const response = await fetch('/test/template-cache', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify({
                        action: 'clear_tag',
                        tag: tag,
                        _token: csrfToken
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showResult('🏷️ ' + result.message, 'success');
                } else {
                    showResult('❌ Failed to clear tag', 'error');
                }
            } catch (error) {
                showResult('❌ Error: ' + error.message, 'error');
            }
        };

        window.testFragmentCaching = async function () {
            try {
                showResult('Testing fragment caching...', 'info');

                const response = await fetch('/test/template-cache', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify({
                        action: 'test_fragment',
                        _token: csrfToken
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showResult('🧪 ' + result.message, 'success');
                } else {
                    showResult('❌ ' + result.message, 'error');
                }
            } catch (error) {
                showResult('❌ Error: ' + error.message, 'error');
            }
        };

        window.testTaggedCaching = async function () {
            try {
                showResult('Testing tagged caching...', 'info');

                const response = await fetch('/test/template-cache', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify({
                        action: 'test_tags',
                        _token: csrfToken
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showResult('🏷️ ' + result.message, 'success');
                } else {
                    showResult('❌ ' + result.message, 'error');
                }
            } catch (error) {
                showResult('❌ Error: ' + error.message, 'error');
            }
        };

        window.refreshStats = function () {
            showResult('🔄 Refreshing...', 'info');
            setTimeout(() => location.reload(), 500);
        };

        window.testTemplate = async function (template) {
            const templateSlug = template.replace(/[^a-z0-9]/gi, '-').toLowerCase();
            const resultElement = document.getElementById('test-result-' + templateSlug);

            if (!resultElement) {
                console.error('Result element not found for template:', template);
                return;
            }

            try {
                resultElement.innerHTML = '⏳ Testing...';

                const startTime = performance.now();

                // Test by requesting the template (if it exists as route)
                const testUrl = '/' + template.replace('pages/', '').replace('/template-cache', '/template-cache-test');

                const response = await fetch(testUrl);
                const endTime = performance.now();

                if (response.ok) {
                    const renderTime = Math.round(endTime - startTime);
                    resultElement.innerHTML = `✅ ${renderTime}ms`;
                    resultElement.style.color = '#28a745';
                } else {
                    resultElement.innerHTML = `ℹ️ No route`;
                    resultElement.style.color = '#6c757d';
                }
            } catch (error) {
                resultElement.innerHTML = `❌ Error`;
                resultElement.style.color = '#dc3545';
            }
        };

        function showResult(message, type) {
            const resultDiv = document.getElementById('operation-result');
            if (resultDiv) {
                resultDiv.innerHTML = message;
                resultDiv.className = 'result-' + type;
            }
        }

        // Make showResult available globally
        window.showResult = showResult;
    });
</script>
{% endblock %}
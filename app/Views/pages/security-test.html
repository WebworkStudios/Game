{% extends "layouts/base.html" %}

{% block title %}{{ page_title }} - {{ app_name }}{% endblock %}


{% block content %}
<div class="security-header" style="text-align: center; margin-bottom: 30px;">
    <h1 style="color: #dc3545; border-bottom: 3px solid #dc3545; padding-bottom: 10px; display: inline-block;">
        üîê {{ page_title }}
    </h1>
</div>

{{ csrf_meta|raw }}

<!-- Flash Messages -->
{% if flash_messages %}
{% for type, message in flash_messages %}
<div class="flash {{ type }}">
    {{ message }}
</div>
{% endfor %}
{% endif %}

<!-- System Status -->
<div class="section">
    <h2>System Status</h2>
    <div class="info-grid">
        <div class="info-box">
            <h3>Session Status</h3>
            <p>
                <span class="status-indicator {% if session_status.started %}status-active{% else %}status-inactive{% endif %}"></span>
                {% if session_status.started %}Active{% else %}Inactive{% endif %}
            </p>
            <p><strong>Session ID:</strong> <code>{{ session_id }}</code></p>
            <p><strong>Expired:</strong> {% if session_status.expired %}Yes{% else %}No{% endif %}</p>
        </div>

        <div class="info-box">
            <h3>CSRF Protection</h3>
            <p>
                <span class="status-indicator status-active"></span>
                Active
            </p>
            <p><strong>Token:</strong> <code>{{ csrf_token }}</code></p>
        </div>

        <div class="info-box">
            <h3>Request Information</h3>
            <p><strong>Method:</strong> {{ request_info.method }}</p>
            <p><strong>Path:</strong> {{ request_info.path }}</p>
            <p><strong>IP:</strong> {{ request_info.ip_address }}</p>
            <p><strong>AJAX:</strong> {% if request_info.is_ajax %}Yes{% else %}No{% endif %}</p>
        </div>
    </div>
</div>

<!-- CSRF Token Information -->
<div class="section">
    <h2>CSRF Token Information</h2>
    <div class="token-info">
        <pre>{{ csrf_info|json }}</pre>
    </div>
</div>

<!-- XSS Protection Examples -->
<div class="section">
    <h2>XSS Protection Examples</h2>
    <p>Die folgenden Beispiele zeigen, wie gef√§hrliche Eingaben sicher behandelt werden:</p>

    {% for example in xss_examples %}
    <div class="example">
        <h4>{{ example.name }} ({{ example.context }})</h4>
        <div class="input">
            <strong>Eingabe:</strong> {{ example.input }}
        </div>
        <div class="output">
            <strong>Sicher escaped:</strong> {{ example.input|escape }}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Form Security Test -->
<div class="section">
    <h2>Form Security Test</h2>
    <form method="POST" action="/test/security" style="background: white; padding: 20px; border-radius: 5px;">
        {{ csrf_field|raw }}

        <div class="form-group">
            <label for="test_input">Test Input (XSS-Versuch):</label>
            <textarea id="test_input" name="test_input" placeholder="Versuchen Sie: <script>alert('XSS')</script>">{{ last_test_input }}</textarea>
        </div>

        <div class="form-group">
            <label for="user_name">Benutzername:</label>
            <input type="text" id="user_name" name="user_name" value="{{ last_user_name }}" placeholder="Max Mustermann">
        </div>

        <div class="form-group">
            <label for="email">E-Mail:</label>
            <input type="email" id="email" name="email" placeholder="test@example.com">
        </div>

        <button type="submit">Sichere Form absenden</button>
    </form>
</div>

<!-- AJAX Security Tests -->
<div class="section">
    <h2>AJAX Security Tests</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
        <button type="button" onclick="testSession()">Session Test</button>
        <button type="button" onclick="testXss()">XSS Test</button>
        <button type="button" onclick="testCsrf()">CSRF Test</button>
        <button type="button" onclick="clearSession()">Session l√∂schen</button>
    </div>

    <div id="ajax-result" class="ajax-result"></div>
</div>

<!-- Safe Examples -->
<div class="section">
    <h2>Sichere Beispiele</h2>
    {% for name, example in safe_examples %}
    <div class="example">
        <h4>{{ name }}</h4>
        <div class="output">
            <strong>Eingabe:</strong> {{ example }}
        </div>
        <div class="output">
            <strong>Ausgabe:</strong> {{ example }}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Security Headers -->
<div class="section">
    <h2>Security Headers</h2>
    <p>Diese Seite wird mit folgenden Security-Headers geliefert:</p>
    <div class="token-info">
        <pre>{{ security_headers|json }}</pre>
    </div>
</div>

<style>
    .section {
        margin: 30px 0;
        padding: 20px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        background: #f8f9fa;
    }

    .section h2 {
        color: #495057;
        margin-top: 0;
        margin-bottom: 15px;
    }

    .flash {
        padding: 15px;
        border-radius: 5px;
        margin: 15px 0;
        border: 1px solid;
    }

    .flash.success {
        background: #d4edda;
        color: #155724;
        border-color: #c3e6cb;
    }

    .flash.error {
        background: #f8d7da;
        color: #721c24;
        border-color: #f5c6cb;
    }

    .token-info {
        background: #e9ecef;
        padding: 15px;
        border-radius: 5px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        overflow-x: auto;
    }

    .example {
        background: #fff;
        padding: 15px;
        margin: 10px 0;
        border-left: 4px solid #007bff;
        border-radius: 0 5px 5px 0;
    }

    .example .input {
        background: #f8d7da;
        padding: 10px;
        border-radius: 3px;
        font-family: monospace;
        margin: 5px 0;
    }

    .example .output {
        background: #d4edda;
        padding: 10px;
        border-radius: 3px;
        font-family: monospace;
        margin: 5px 0;
    }

    .form-group {
        margin-bottom: 15px;
    }

    label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #495057;
    }

    input[type="text"], input[type="email"], textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
    }

    textarea {
        height: 100px;
        resize: vertical;
    }

    button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-right: 10px;
    }

    button:hover {
        background: #0056b3;
    }

    .ajax-result {
        margin-top: 15px;
        padding: 15px;
        border-radius: 5px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        display: none;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .info-box {
        background: white;
        padding: 15px;
        border-radius: 5px;
        border: 1px solid #dee2e6;
    }

    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }

    .status-active {
        background: #28a745;
    }

    .status-inactive {
        background: #dc3545;
    }

    pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 3px;
        overflow-x: auto;
        font-size: 12px;
    }
</style>

<script>
    // CSRF Token aus Meta-Tag holen
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    function showResult(data, isError = false) {
        const resultDiv = document.getElementById('ajax-result');
        resultDiv.style.display = 'block';
        resultDiv.style.background = isError ? '#f8d7da' : '#d4edda';
        resultDiv.style.color = isError ? '#721c24' : '#155724';
        resultDiv.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
    }

    function testSession() {
        fetch('/test/security', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                action: 'set_session',
                key: 'test_key',
                value: 'Test Value ' + Date.now()
            })
        })
            .then(response => response.json())
            .then(data => showResult(data))
            .catch(error => showResult(error, true));
    }

    function testXss() {
        const xssPayload = '<script>alert("XSS Test")</script>';
fetch('/test/security', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
'X-CSRF-Token': csrfToken,
'X-Requested-With': 'XMLHttpRequest'
},
body: JSON.stringify({
action: 'test_xss',
input: xssPayload
})
})
.then(response => response.json())
.then(data => showResult(data))
.catch(error => showResult(error, true));
}

function testCsrf() {
fetch('/test/security', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
'X-CSRF-Token': csrfToken,
'X-Requested-With': 'XMLHttpRequest'
},
body: JSON.stringify({
action: 'test_csrf'
})
})
.then(response => response.json())
.then(data => showResult(data))
.catch(error => showResult(error, true));
}

function clearSession() {
if (confirm('Session wirklich l√∂schen?')) {
fetch('/test/security', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
'X-CSRF-Token': csrfToken,
'X-Requested-With': 'XMLHttpRequest'
},
body: JSON.stringify({
action: 'clear_session'
})
})
.then(response => response.json())
.then(data => showResult(data))
.catch(error => showResult(error, true));
}
}
</script>
{% endblock %}
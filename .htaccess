# Football Manager - Apache Configuration
# High-performance and secure .htaccess for PHP 8.4 application

# ============================================================================
# REWRITE ENGINE & CORE SETUP
# ============================================================================

RewriteEngine On
RewriteBase /

# Set server signature
ServerSignature Off

# ============================================================================
# SECURITY HEADERS
# ============================================================================

# Security Headers for modern browsers
<IfModule mod_headers.c>
    # Content Security Policy - Restrictive but functional
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://fonts.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://fonts.gstatic.com; font-src 'self' https://fonts.googleapis.com https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'"

    # XSS Protection
    Header always set X-XSS-Protection "1; mode=block"

    # Content Type Options
    Header always set X-Content-Type-Options "nosniff"

    # Frame Options
    Header always set X-Frame-Options "DENY"

    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Permissions Policy (Feature Policy replacement)
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=()"

    # HSTS (HTTP Strict Transport Security) - Only enable if using HTTPS
    # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # Remove server information
    Header always unset Server
    Header always unset X-Powered-By

    # Correlation ID for request tracking
    Header always set X-Correlation-ID "%{CORRELATION_ID}e" env=CORRELATION_ID
</IfModule>

# Generate correlation ID for each request
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP:X-Correlation-ID} ^$
    RewriteRule .* - [E=CORRELATION_ID:%{TIME_STAMP}-%{REMOTE_ADDR}]

    RewriteCond %{HTTP:X-Correlation-ID} !^$
    RewriteRule .* - [E=CORRELATION_ID:%{HTTP:X-Correlation-ID}]
</IfModule>

# ============================================================================
# PERFORMANCE OPTIMIZATION
# ============================================================================

# Enable compression
<IfModule mod_deflate.c>
    # Compress HTML, CSS, JavaScript, Text, XML and fonts
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/x-font
    AddOutputFilterByType DEFLATE application/x-font-opentype
    AddOutputFilterByType DEFLATE application/x-font-otf
    AddOutputFilterByType DEFLATE application/x-font-truetype
    AddOutputFilterByType DEFLATE application/x-font-ttf
    AddOutputFilterByType DEFLATE application/x-font-woff
    AddOutputFilterByType DEFLATE application/x-font-woff2
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE font/opentype
    AddOutputFilterByType DEFLATE font/otf
    AddOutputFilterByType DEFLATE font/ttf
    AddOutputFilterByType DEFLATE font/woff
    AddOutputFilterByType DEFLATE font/woff2
    AddOutputFilterByType DEFLATE image/svg+xml
    AddOutputFilterByType DEFLATE image/x-icon
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/xml

    # Remove browser bugs (only needed for really old browsers)
    BrowserMatch ^Mozilla/4 gzip-only-text/html
    BrowserMatch ^Mozilla/4\.0[678] no-gzip
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
    Header append Vary User-Agent
</IfModule>

# Enable Brotli compression if available
<IfModule mod_brotli.c>
    AddOutputFilterByType BROTLI_COMPRESS text/plain
    AddOutputFilterByType BROTLI_COMPRESS text/css
    AddOutputFilterByType BROTLI_COMPRESS text/xml
    AddOutputFilterByType BROTLI_COMPRESS text/javascript
    AddOutputFilterByType BROTLI_COMPRESS application/javascript
    AddOutputFilterByType BROTLI_COMPRESS application/json
    AddOutputFilterByType BROTLI_COMPRESS application/xml
    AddOutputFilterByType BROTLI_COMPRESS application/rss+xml
    AddOutputFilterByType BROTLI_COMPRESS application/xhtml+xml
    AddOutputFilterByType BROTLI_COMPRESS font/woff
    AddOutputFilterByType BROTLI_COMPRESS font/woff2
    AddOutputFilterByType BROTLI_COMPRESS image/svg+xml
</IfModule>

# ============================================================================
# BROWSER CACHING
# ============================================================================

<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresDefault "access plus 1 hour"

    # CSS and JavaScript
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType text/javascript "access plus 1 year"

    # Images
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    ExpiresByType image/avif "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"

    # Fonts
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/otf "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"

    # HTML and other dynamic content
    ExpiresByType text/html "access plus 10 minutes"
    ExpiresByType application/json "access plus 10 minutes"
    ExpiresByType application/xml "access plus 10 minutes"

    # Documents
    ExpiresByType application/pdf "access plus 1 week"

    # Manifest files
    ExpiresByType application/manifest+json "access plus 1 week"
    ExpiresByType text/cache-manifest "access plus 0 seconds"
</IfModule>

# Alternative cache headers using mod_headers
<IfModule mod_headers.c>
    # CSS and JS
    <FilesMatch "\.(css|js)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>

    # Images
    <FilesMatch "\.(jpg|jpeg|png|gif|webp|avif|svg)$">
        Header set Cache-Control "public, max-age=2592000"
    </FilesMatch>

    # Fonts
    <FilesMatch "\.(woff|woff2|ttf|otf|eot)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>

    # HTML
    <FilesMatch "\.html$">
        Header set Cache-Control "public, max-age=600"
    </FilesMatch>

    # Don't cache dynamic PHP files
    <FilesMatch "\.php$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires 0
    </FilesMatch>
</IfModule>

# ETags for better caching
<IfModule mod_headers.c>
    Header unset ETag
</IfModule>
FileETag None

# ============================================================================
# SECURITY RESTRICTIONS
# ============================================================================

# Block access to sensitive files
<FilesMatch "(^#.*#|\.(bak|conf|dist|fla|inc|ini|log|orig|psd|sh|sql|sw[op])|~)$">
    Require all denied
</FilesMatch>

# Block access to .htaccess and .htpasswd
<Files ".ht*">
    Require all denied
</Files>

# Block access to PHP configuration files
<FilesMatch "^(composer\.(json|lock)|package(-lock)?\.json|\.env(\..+)?|phpunit\.xml)$">
    Require all denied
</FilesMatch>

# Block access to framework and src directories via web
RewriteRule ^(framework|src|config|storage|tests|vendor)/ - [R=404,L]

# Block access to composer files
RewriteRule ^composer\.(json|lock)$ - [R=404,L]

# Block access to environment files
RewriteRule ^\.env - [R=404,L]

# Block access to log files
RewriteRule \.log$ - [R=404,L]

# Prevent script injection
RewriteCond %{QUERY_STRING} (<|%3C)([^s]*s)+cript.*(>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} (<|%3C)([^e]*e)+mbed.*(>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} (<|%3C)([^o]*o)+bject.*(>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} (<|%3C)([^i]*i)+frame.*(>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} base64_(en|de)code[^(]*\([^)]*\) [NC,OR]
RewriteCond %{QUERY_STRING} (%0A|%0D|\\r|\\n) [NC,OR]
RewriteCond %{QUERY_STRING} union([^a]*a)+ll([^s]*s)+elect [NC]
RewriteRule .* - [F]

# Block suspicious user agents
RewriteCond %{HTTP_USER_AGENT} ^$ [OR]
RewriteCond %{HTTP_USER_AGENT} ^(-|\.|') [OR]
RewriteCond %{HTTP_USER_AGENT} ^(.*(libwww-perl|wget|python|nikto|curl|scan|java|winhttp|clshttp|loader)) [NC,OR]
RewriteCond %{HTTP_USER_AGENT} ^(.*)(libwww-perl|wget|python|nikto|curl|scan|java|winhttp|HTTrack|clshttp|archiver|loader|email|harvest|extract|grab|miner)) [NC]
RewriteRule .* - [F]

# Block request methods that aren't needed
RewriteCond %{REQUEST_METHOD} ^(HEAD|TRACE|DELETE|TRACK|DEBUG) [NC]
RewriteRule .* - [F]

# ============================================================================
# PHP CONFIGURATION
# ============================================================================

<IfModule mod_php8.c>
    # Security settings
    php_flag log_errors On
    php_flag display_errors Off
    php_flag display_startup_errors Off
    php_flag expose_php Off
    php_flag allow_url_fopen Off
    php_flag allow_url_include Off

    # Session security
    php_value session.cookie_httponly 1
    php_value session.cookie_secure 0
    php_value session.use_only_cookies 1
    php_value session.cookie_samesite "Strict"

    # Upload limits
    php_value upload_max_filesize "10M"
    php_value post_max_size "10M"
    php_value max_execution_time 30
    php_value max_input_time 60
    php_value memory_limit "256M"

    # Error reporting
    php_value error_reporting "E_ALL & ~E_DEPRECATED & ~E_STRICT"
    php_value log_errors_max_len 1024

    # Timezone
    php_value date.timezone "Europe/Berlin"
</IfModule>

# ============================================================================
# URL REWRITING
# ============================================================================

# Handle CORS preflight requests
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule ^(.*)$ $1 [R=200,L]

# Add trailing slash to directories
RewriteCond %{REQUEST_FILENAME} -d
RewriteCond %{REQUEST_URI} !/$
RewriteRule ^(.*)$ $1/ [R=301,L]

# Remove multiple slashes
RewriteCond %{THE_REQUEST} //
RewriteRule .* /$0 [R=301,L]

# Main routing - send everything to index.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ index.php [QSA,L]

# ============================================================================
# MIME TYPES
# ============================================================================

<IfModule mod_mime.c>
    # Web fonts
    AddType application/font-woff .woff
    AddType application/font-woff2 .woff2
    AddType application/vnd.ms-fontobject .eot
    AddType font/ttf .ttf
    AddType font/otf .otf

    # Modern image formats
    AddType image/webp .webp
    AddType image/avif .avif

    # JavaScript
    AddType application/javascript .js
    AddType application/json .json

    # CSS
    AddType text/css .css

    # SVG
    AddType image/svg+xml .svg .svgz

    # Manifest
    AddType application/manifest+json .webmanifest
    AddType text/cache-manifest .appcache
</IfModule>

# ============================================================================
# ERROR PAGES
# ============================================================================

# Custom error pages
ErrorDocument 400 /error/400.html
ErrorDocument 401 /error/401.html
ErrorDocument 403 /error/403.html
ErrorDocument 404 /error/404.html
ErrorDocument 500 /error/500.html
ErrorDocument 502 /error/502.html
ErrorDocument 503 /error/503.html

# ============================================================================
# ADDITIONAL OPTIMIZATIONS
# ============================================================================

# Follow symbolic links
Options +FollowSymLinks

# Disable server-side includes and CGI execution
Options -Includes -ExecCGI

# Disable directory browsing
Options -Indexes

# Enable MultiViews for content negotiation
Options +MultiViews

# Set default character set
AddDefaultCharset UTF-8

# Force UTF-8 for certain file formats
<IfModule mod_mime.c>
    AddCharset UTF-8 .atom .css .js .json .rss .vtt .webapp .xml
</IfModule>

# ============================================================================
# RATE LIMITING (if mod_evasive is available)
# ============================================================================

<IfModule mod_evasive24.c>
    DOSHashTableSize    2048
    DOSPageCount        5
    DOSPageInterval     1
    DOSSiteCount        50
    DOSSiteInterval     1
    DOSBlockingPeriod   600
    DOSLogDir           /var/log/httpd/dos_log
    DOSEmailNotify      admin@footballmanager.com
    DOSWhitelist        127.0.0.1
</IfModule>

# ============================================================================
# DEVELOPMENT HELPERS
# ============================================================================

# Enable rewrite logging for development (disable in production)
# RewriteLog /var/log/apache2/rewrite.log
# RewriteLogLevel 3

# Development CORS headers (adjust for production)
<IfModule mod_headers.c>
    # Allow CORS for development
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-Correlation-ID"
    Header always set Access-Control-Expose-Headers "X-Correlation-ID"
    Header always set Access-Control-Max-Age "86400"
</IfModule>